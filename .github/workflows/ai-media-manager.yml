name: AI Auto PR for Media-Manager

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  ai_pr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Collect git diff
      id:diff
      run: |
        DIFF=$(git diff HEAD~1 HEAD -- src/media_manager || true)
        echo "DIFF<<EOF" >> $GITHUB_ENV
        echo "$DIFF" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    - name: Skip if no diff
      if: env.DIFF == ''
      run: echo "No diff found in src/media_manager/, skipping." && exit 0
    - name: Ask AI to generate improved patch
      id: ai
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        DIFF: ${ env.DIFF }
      run: |
        echo "Calling AI to improve patch..."
        RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -d "{\"model\": \"gpt-4.1\",\"messages\": [{\"role\": \"system\",\"content\": \"You are a senior Python/PySide6 architect. Improve patches for media-manager...\"},{\"role\": \"user\",\"content\": \"Here is the git diff inside src/media_manager:\n$DIFF\"}]}" | jq -r '.choices[0].message.content')
        echo "AI_PATCH<<EOF" >> $GITHUB_ENV
        echo "$RESPONSE" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    - name: Save patch
      run: echo "$AI_PATCH" > ai_patch.diff
    - name: Apply patch
      run: git apply --verbose ai_patch.diff || echo "⚠ Patch might be empty or conflicting."
    - name: Check changes
      id: check
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    - name: Skip PR when nothing changed
      if: steps.check.outputs.changed == 'false'
      run: echo "No code changed after applying patch. Skip PR." && exit 0
    - name: Create PR
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "AI Auto Improvements for Media-Manager"
        title: "AI Auto PR – Media-Manager Code Enhancements"
        body: "This Pull Request was automatically generated by AI.\n\nIncludes improvements based on: \n- PySide6 UI clean-up\n- i18n language loading\n- PyInstaller compatibility\n- Logging fixes\n- API providers refactor"
        branch: "ai-auto-media-manager"
